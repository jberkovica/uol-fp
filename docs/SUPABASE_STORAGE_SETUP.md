# Supabase Storage Setup Instructions

## Overview
This guide will help you set up Supabase Storage buckets for storing story cover images generated by DALL-E 3.

## Step 1: Access Supabase Storage

1. Go to your Supabase project dashboard
2. Click on **Storage** in the left sidebar (the icon looks like a folder)

## Step 2: Create the Story Covers Bucket

### Create New Bucket
1. Click the **"New bucket"** button
2. Enter the following details:
   - **Name**: `story-covers`
   - **Public bucket**: Toggle this **ON** (green) - This allows images to be accessed via public URLs
   - **File size limit**: Leave default or set to `5MB` (images won't be larger than 1-2MB)
   - **Allowed MIME types**: Add these (optional but recommended):
     ```
     image/png
     image/jpeg
     image/jpg
     ```

3. Click **Create bucket**

## Step 3: Configure Bucket Policies (RLS)

After creating the bucket, you need to set up policies to allow your backend to upload images:

### 3.1 Upload Policy (INSERT)
1. Click on the `story-covers` bucket
2. Go to the **Policies** tab
3. Click **New Policy** → **For full customization**
4. Configure as follows:
   - **Policy name**: `Allow authenticated uploads`
   - **Target roles**: Select `authenticated`
   - **WITH CHECK expression**:
   ```sql
   true
   ```
   - **Operations**: Check only **INSERT**
5. Click **Save policy**

### 3.2 Public Read Policy (SELECT)
1. Click **New Policy** again
2. Configure as follows:
   - **Policy name**: `Allow public read access`
   - **Target roles**: Select `anon` (anonymous)
   - **USING expression**:
   ```sql
   true
   ```
   - **Operations**: Check only **SELECT**
3. Click **Save policy**

### 3.3 Update Policy (UPDATE) - Optional
If you want to allow updating images:
1. Click **New Policy**
2. Configure as follows:
   - **Policy name**: `Allow authenticated updates`
   - **Target roles**: Select `authenticated`
   - **USING expression**:
   ```sql
   auth.uid() IS NOT NULL
   ```
   - **Operations**: Check only **UPDATE**
3. Click **Save policy**

## Step 4: Verify Bucket Structure

Your storage structure will look like this:
```
story-covers/
├── {story_id}/
│   ├── cover.png        # Full size image (1024x1024)
│   └── thumbnail.png    # Thumbnail (200x200)
```

## Step 5: Test the Setup

You can test if the bucket is properly configured:

1. In Supabase Storage, click on your `story-covers` bucket
2. Try uploading a test image manually
3. After upload, click on the image
4. Click **Get URL** - you should see a public URL
5. Open the URL in a new browser tab - the image should display

## Step 6: Environment Variables

Make sure your backend has these environment variables configured:

```bash
# Your Supabase project URL
SUPABASE_URL=https://YOUR_PROJECT_ID.supabase.co

# Your Supabase anon/public key (safe to use in backend)
SUPABASE_KEY=eyJ...your-anon-key...

# OpenAI API key for DALL-E 3
OPENAI_API_KEY=sk-...your-openai-key...
```

## Image Generation Settings (Optimized for Speed)

The system is configured with these optimized settings:
- **Size**: 1024x1024 (smallest DALL-E 3 size)
- **Quality**: Standard (2x faster than HD, 2x cheaper)
- **Style**: Natural (realistic children's book style)
- **Thumbnail**: 200x200 (small, fast loading)

### Cost & Performance Estimates:
- **Generation time**: ~5-7 seconds (standard quality)
- **Cost per image**: ~$0.04 (standard quality)
- **Storage used**: ~1-2MB per story (cover + thumbnail)

## Troubleshooting

### Issue: "Permission denied" when uploading
- Check that your bucket policies are correctly configured
- Verify your Supabase API key has the right permissions
- Make sure the bucket is set to "public"

### Issue: Images not displaying in app
- Verify the bucket is public
- Check that the SELECT policy allows anonymous access
- Test the image URL directly in a browser

### Issue: Slow image generation
- Already optimized to use "standard" quality instead of "hd"
- DALL-E 3 minimum size (1024x1024) is already configured
- Consider implementing a queue system for batch processing if needed

## Optional: Create Additional Buckets

You might also want to create these buckets using the same process:

1. **`user-uploads`** - For storing children's drawings (if not already exists)
2. **`background-music`** - For background music files (if not already exists)
3. **`story-audio`** - For TTS generated audio files (if not already exists)

Each bucket should have similar policies based on your needs.

## Database Migration

Run this SQL migration to add cover image fields to your stories table (if not already done):

```sql
-- Add columns for story images if they don't exist
ALTER TABLE stories 
ADD COLUMN IF NOT EXISTS cover_image_url TEXT,
ADD COLUMN IF NOT EXISTS cover_image_thumbnail_url TEXT,
ADD COLUMN IF NOT EXISTS cover_image_metadata JSONB DEFAULT '{}',
ADD COLUMN IF NOT EXISTS cover_image_generated_at TIMESTAMP WITH TIME ZONE;

-- Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_stories_cover_image 
ON stories(id) 
WHERE cover_image_url IS NOT NULL;
```

## Notes

- Images are generated asynchronously after story creation
- If image generation fails, the story still completes successfully
- Thumbnails are automatically created for faster loading in story lists
- The system includes fallback to default images if generation fails